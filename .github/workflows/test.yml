name: Go Test Pipeline

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:13
        env:
          POSTGRES_USER: validator
          POSTGRES_PASSWORD: val1dat0r
          POSTGRES_DB: project-sem-1
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
    - uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'

    - name: Install dependencies
      run: |
        go mod tidy
        go mod download

    - name: Build
      run: go build -o bin/server main.go

    - name: Wait for PostgreSQL
      run: |
        while ! pg_isready -h localhost -p 5432; do
          echo "Waiting for PostgreSQL..."
          sleep 2
        done

    - name: Initialize database
      run: |
        psql -h localhost -U validator -d project-sem-1 -c "
        CREATE TABLE IF NOT EXISTS prices (
            id SERIAL PRIMARY KEY,
            product_id VARCHAR(255) NOT NULL,
            created_date DATE NOT NULL,
            product_name TEXT NOT NULL,
            category TEXT NOT NULL,
            price DECIMAL(10,2) NOT NULL
        );"

    - name: Run tests
      run: |
        # Start server in BACKGROUND
        echo "ğŸš€ Starting server in background..."
        ./bin/server &
        SERVER_PID=$!
        echo "Server PID: $SERVER_PID"
        
        # Wait for server to be ready
        echo "â³ Waiting for server to start..."
        for i in {1..30}; do
          if curl -s http://localhost:8080/health > /dev/null; then
            echo "âœ… Server is ready after $i attempts"
            break
          fi
          if [ $i -eq 30 ]; then
            echo "âŒ Server failed to start after 30 attempts"
            exit 1
          fi
          sleep 2
        done
        
        # Run tests
        echo "ğŸ§ª Running tests..."
        chmod +x scripts/tests.sh
        ./scripts/tests.sh 1
        TEST_RESULT=$?
        
        # Stop server
        echo "ğŸ›‘ Stopping server (PID: $SERVER_PID)..."
        kill $SERVER_PID
        sleep 2
        
        exit $TEST_RESULT

    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: test-results
        path: |
          response.zip
          test_data.zip
        retention-days: 1
